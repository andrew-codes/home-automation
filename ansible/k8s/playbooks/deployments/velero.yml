---
- hosts: cluster_primary
  become: yes
  become_method: sudo
  become_user: root
  gather_facts: yes
  connection: ssh
  remote_user: hl
  vars_files:
    - ../../.secrets/setup_k8s.yml

  tasks:
    - name: Install Velero CLI
      become_user: root
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - curl -fsSL -o velero.tar.gz https://github.com/vmware-tanzu/velero/releases/download/v1.5.3/velero-v1.5.3-linux-amd64.tar.gz
        - tar -xvf velero.tar.gz
        - mv velero-v1.5.3-linux-amd64/velero /usr/local/bin

    - name: Create .secrets directory
      become_user: hl
      become_method: sudo
      become: yes
      shell: mkdir -p /home/{{ ansible_user }}/.secrets

    - name: Copy cloud_credentials.ini
      copy:
        src: ./../../.secrets/backup-cloud-credentials.ini
        dest: /home/{{ ansible_user }}/.secrets/backup-cloud-credentials.ini
        owner: hl
        mode: "0644"

    - name: Copy velero namespace
      copy:
        src: ./../../../../k8s/setup/velero-namespace.yml
        dest: /home/{{ ansible_user }}/velero-namespace.yml
        owner: hl
        mode: "0644"

    - name: Create namespace
      become_user: hl
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - kubectl apply -f velero-namespace.yml

    - name: Install Velero for Azure
      become_user: hl
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - velero install --provider azure --plugins velero/velero-plugin-for-microsoft-azure:v1.2.0 --bucket {{ blob_container }} --secret-file=.secrets/backup-cloud-credentials.ini --backup-location-config resourceGroup={{ azure_backup_resource_group }},storageAccount={{ azure_storage_account_id }},subscriptionId={{ azure_backup_subscription_id }} --snapshot-location-config resourceGroup={{ azure_backup_resource_group }},subscriptionId={{ azure_backup_subscription_id }} --default-volumes-to-restic --use-restic

    - name: Delete secrets
      become_user: hl
      become_method: sudo
      become: yes
      shell: rm -rf /home/{{ ansible_user }}/.secrets/*
