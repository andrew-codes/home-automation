---
- hosts: cluster_primary
  become: yes
  become_method: sudo
  become_user: root
  gather_facts: yes
  connection: ssh
  remote_user: hl
  vars_files:
    - ../../.secrets/setup_k8s.yml

  tasks:
    - name: Create .secrets directory
      become_user: hl
      become_method: sudo
      become: yes
      shell: mkdir -p /home/{{ ansible_user }}/.secrets

    - name: Copy azure creds
      copy:
        src: ./../../.secrets/azure-cloud-credentials.json
        dest: /home/{{ ansible_user }}/.secrets/azure-cloud-credentials
        owner: hl
        mode: "0644"

    - name: Inlets for DigitalOcean
      become_user: hl
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - kubectl create secret generic cert --dry-run=client -from-file=inlets-access-key=/home/{{ ansible_user }}/.secrets/azure-cloud-credentials -o json >"/home/{{ ansible_user }}/.secrets/azure-cloud-credentials-kubectl-secret.json"
        - kubeseal <"/home/{{ ansible_user }}/.secrets/azure-cloud-credentials-kubectl-secret.json" >"/home/{{ ansible_user }}/.secrets/azure-cloud-credentials.json"
        - kubectl apply -f .secrets/azure-cloud-credentials.json
        - arkade install inlets-operator provider=azure,region=eastus,subscriptionID={{ azure_subscription_id }},inletsProLicense={{ inlets_pro_license }}

    - name: Delete secrets
      become_user: hl
      become_method: sudo
      become: yes
      shell: rm -rf /home/{{ ansible_user }}/.secrets/*