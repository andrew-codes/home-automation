---
- hosts: cluster_primary
  become: yes
  become_method: sudo
  become_user: root
  gather_facts: yes
  connection: ssh
  remote_user: hl
  vars_files:
    - ../../.secrets/setup_k8s.yml

  tasks:
    - name: Create secrets directory
      become_user: hl
      become_method: sudo
      become: yes
      shell: mkdir -p /home/{{ ansible_user }}/secrets

    - name: Copy azure creds
      copy:
        src: ./../../.secrets/azure-cloud-credentials.json
        dest: /home/{{ ansible_user }}/secrets/azure-cloud-credentials.json
        owner: hl
        mode: "0644"

    - name: Copy inlets license
      copy:
        src: ./../../.secrets/inlets-pro.license
        dest: /home/{{ ansible_user }}/secrets/inlets-pro.license
        owner: hl
        mode: "0644"

    - name: Inlets for Azure
      become_user: hl
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - arkade install inlets-operator --provider azure --region eastUS --token-file /home/{{ ansible_user }}/secrets/azure-cloud-credentials.json --license-file /home/{{ ansible_user }}/secrets/inlets-pro.license --subscription-id {{ azure_inlets_subscription_id }}