---
- hosts: cluster_primary
  become: yes
  become_method: sudo
  become_user: root
  gather_facts: yes
  connection: ssh
  remote_user: hl

  tasks:
    - name: Copy initial setup manifests
      copy:
        src: ./../../../k8s/setup/
        dest: /home/{{ ansible_user }}/
        owner: hl
        mode: "0644"

    - name: Install Arkade
      become_user: root
      become_method: sudo
      become: yes
      shell: curl -sLS https://dl.get-arkade.dev | sh

    - name: Install helm
      become_user: root
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
        - chmod 700 get_helm.sh
        - ./get_helm.sh

    - name: Allow pods on main node
      become_user: hl
      become_method: sudo
      become: yes
      shell: kubectl taint nodes --all node-role.kubernetes.io/master-

- import_playbook: deployments/sealed_secrets.yml
- import_playbook: deployments/velero.yml
- import_playbook: deployments/dashboard.yml
- import_playbook: deployments/inlets.yml
- import_playbook: deployments/nginx.yml
- import_playbook: deployments/docker_registry.yml
