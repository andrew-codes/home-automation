
---
- hosts: mains, workers
  become: yes
  become_method: sudo
  become_user: root
  gather_facts: yes
  connection: ssh
  
  tasks:
    - name: Copy flannel setup
      copy:
        src: ./../../k8s/setup/flannel.yml
        dest: /home/{{ ansible_user }}/flannel.yml
        owner: hl
        mode: "0644"
    
    - name: Copy flannel network config
      copy:
        src: ./../../k8s/setup/flannel-network-config.yml
        dest: /home/{{ ansible_user }}/flannel-network-config.yml
        owner: hl
        mode: "0644"
    
    - name: Copy flannel network config value
      copy:
        src: ./../../k8s/setup/tmp/flannel-pod-network-cidr.json
        dest: /home/{{ ansible_user }}/flannel-pod-network-cidr.json
        owner: hl
        mode: "0644"

    - name: Update flannel network config
      shell: NET_JSON=$(cat /home/{{ ansible_user }}/flannel-pod-network-cidr.json) yq eval -i '.data."net-conf.json" =strenv(NET_JSON)' /home/{{ ansible_user }}/flannel-network-config.yml

    - name: Create Pod Network & RBAC.
      become_user: hl
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - kubectl apply -f /home/{{ ansible_user }}/flannel-network-config.yml
        - kubectl apply -f /home/{{ ansible_user }}/flannel.yml