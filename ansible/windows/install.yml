---
- hosts: gaming_pc
  gather_facts: yes
  connection: winrm
  vars_files:
    - .secrets/windows.yml

  tasks:
    - name: Ensure 7-Zip is installed via Chocolatey
      win_chocolatey:
        name: 7zip
        state: present

    - name: Install the Win32-OpenSSH service
      win_chocolatey:
        name: openssh
        package_params: /SSHServerFeature /AlsoLogToFile
        state: present

    - name: Create .ssh directory
      win_shell: mkdir -p C:\Users\{{ ansible_user }}\.ssh\authorized_key
      vars:
        ansible_become_user: "{{ ansible_user }}"
        ansible_become_password: "{{ ansible_password }}"

    - name: Copy Home Automation Public SSH Key
      ansible.windows.win_copy:
        src: .secrets/home-automation-ssh.Public
        dest: C:\Users\{{ ansible_user }}\.ssh\authorized_key
      vars:
        ansible_become_user: "{{ ansible_user }}"
        ansible_become_password: "{{ ansible_password }}"
        ansible_remote_tmp: 'C:\tmp'
    
    - name: Copy sshd_config
      ansible.windows.win_copy:
        src: sshd_config
        dest: C:\ProgramData\ssh\sshd_config
      vars:
        ansible_become_user: BUILTIN\Administrators
        ansible_become_password: "{{ ansible_password }}"
        ansible_remote_tmp: 'C:\tmp'

    - name: Restart SSH Service
      win_shell: |
        Get-Service -Name sshd | Restart-Service

    - name: Setup Admin SSH Key
      win_shell: |
        New-Item -Path C:\ProgramData\ssh\administrators_authorized_keys -ItemType File
        $acl = Get-Acl C:\ProgramData\ssh\administrators_authorized_keys
        $acl.SetAccessRuleProtection($true, $false)
        $administratorsRule = New-Object system.security.accesscontrol.filesystemaccessrule("Administrators","FullControl","Allow")
        $systemRule = New-Object system.security.accesscontrol.filesystemaccessrule("SYSTEM","FullControl","Allow")
        $acl.SetAccessRule($administratorsRule)
        $acl.SetAccessRule($systemRule)
        $acl | Set-Acl
    - name: Restart SSH Service
      win_shell: |
        Get-Service -Name sshd | Restart-Service
