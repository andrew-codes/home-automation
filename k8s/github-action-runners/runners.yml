apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: github-action-runners
  namespace: actions-runner-system
spec:
  replicas: 3
  template:
    spec:
      labels:
        - amd64-runner
        - nodejs-runner
      repository: andrew-codes/home-automation
      dockerEnabled: true
      dockerdWithinRunnerContainer: true
      imagePullSecrets:
        - name: regcred
      image: docker.smith-simms.family:5000/github-action-runner:latest
      imagePullPolicy: Always
      volumeMounts:
        - name: docker-config-volume
          mountPath: /home/runner/.docker/config.json
          subPath: .dockerconfigjson
        - name: kubectl-config-volume
          mountPath: /home/runner/.kube/config
          subPath: kubectl-config
        - name: docker-sock
          mountPath: /var/run/docker.sock
      volumes:
        - name: docker-config-volume
          secret:
            secretName: regcred
        - name: kubectl-config-volume
          secret:
            secretName: kubectl-config
        - name: docker-sock
          hostPath:
            path: /var/run/docker.sock

      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/arch
                    operator: In
                    values:
                      - amd64
