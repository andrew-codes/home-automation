kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: k8s
subjects:
  - kind: ServiceAccount
    name: k8s
    namespace: default
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: k8s

---
apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: github-runner-deployment
spec:
  template:
    spec:
      serviceAccountName: k8s
      repository: andrew-codes/home-automation
      labels:
        - amd64-runner
        - github-action-runner
      dockerEnabled: true
      dockerdWithinRunnerContainer: false
      imagePullSecrets:
        - name: regcred
      image: docker-registry:5000/github-action-runner:latest
      resources:
        requests:
          ephemeral-storage: "2Gi"
        limits:
          ephemeral-storage: "4Gi"
      imagePullPolicy: Always
      env:
        - name: DOCKER_HOST
          value: localhost:2736
      volumeMounts:
        - name: ssh-volume
          mountPath: /root/.ssh
      volumes:
        - name: ssh-volume
          secret:
            secretName: github-action-runners-home-automation-private-ssh-key
            defaultMode: 0600
            items:
              - key: secret-value
                path: id_rsa
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/arch
                    operator: In
                    values:
                      - amd64
---
apiVersion: actions.summerwind.dev/v1alpha1
kind: HorizontalRunnerAutoscaler
metadata:
  name: runner-deployment-autoscaler
spec:
  scaleDownDelaySecondsAfterScaleOut: 60
  scaleTargetRef:
    name: github-runner-deployment
  minReplicas: 1
  maxReplicas: 5
  metrics:
    - type: TotalNumberOfQueuedAndInProgressWorkflowRuns
      repositoryNames:
        - andrew-codes/home-automation
