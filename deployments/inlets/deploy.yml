---
- hosts: all
  become: yes
  become_method: sudo
  become_user: root
  gather_facts: yes
  connection: ssh
  remote_user: hl
  vars_files:
    - .secrets/ansible-secrets.yml

  tasks:
    - name: Install Arkade
      become_user: root
      become_method: sudo
      become: yes
      shell: curl -sLS https://dl.get-arkade.dev | sh

    - name: Create secrets directory
      become_user: hl
      become_method: sudo
      become: yes
      shell: mkdir -p /home/{{ ansible_user }}/secrets

    - name: Copy azure creds
      copy:
        src: ./.secrets/azure-cloud-credentials.json
        dest: /home/{{ ansible_user }}/secrets/azure-cloud-credentials.json
        owner: hl
        mode: 0644

    - name: Copy inlets license
      copy:
        src: ./.secrets/inlets-pro.license
        dest: /home/{{ ansible_user }}/secrets/inlets-pro.license
        owner: hl
        mode: 0644

    - name: Inlets for Azure
      become_user: hl
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - arkade install inlets-operator --provider azure --region eastUS --token-file /home/{{ ansible_user }}/secrets/azure-cloud-credentials.json --license-file /home/{{ ansible_user }}/secrets/inlets-pro.license --subscription-id {{ azure_inlets_subscription_id }}

    - name: nginx Ingress
      become_user: hl
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - ark install nginx-ingress

    - name: Cert Manager
      become_user: hl
      become_method: sudo
      become: yes
      command: "{{ item }}"
      with_items:
        - kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.6.1/cert-manager.yaml
