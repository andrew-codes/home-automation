---
- hosts: all
  become: yes
  become_method: ansible.builtin.sudo
  become_user: root
  gather_facts: yes
  connection: ssh
  remote_user: root

  tasks:
    - name: Ensure LXC container is started
      command: pct start {{ vmId }}
      register: start_container
      changed_when: start_container.rc == 0

    - name: Ensure LXC container is running
      command: pct exec {{ vmId }} -- bash -c "while ! (systemctl is-active kubelet 2>/dev/null); do sleep 1; done"
      register: wait_for_kubelet
      changed_when: false
