automation:
  - alias: Notify family members that packages have been delivered
    trigger:
      - platform: state
        entity_id: binary_sensor.are_packages_delivered
        to: "on"
    action:
      - service: notify.mobile_app_andrew_s_iphone
        data_template:
          title: Package Delivery
          message: "You have delivered packages"
          data:
            url: /lovelace/mail
            push:
              thread-id: deliveries
      - service: notify.mobile_app_dorri_s_iphone
        data_template:
          title: Package Delivery
          message: "You have delivered packages"
          data:
            url: /lovelace/mail
            push:
              thread-id: deliveries

sensor:
  - platform: template
    sensors:
      number_of_packages:
        friendly_name: Number of Packages
        value_template: >
          {{(states("sensor.mail_usps_delivering")|int) + (states("sensor.mail_fedex_delivering")|int) + (states("sensor.mail_ups_delivering")|int) + (states("sensor.mail_amazon_packages")|int)}}
      mail_deliveries_message:
        friendly_name: Deliveries Summary
        value_template: > 
          {# Deliveries Sentence #}
            {% macro deliveries_sentence() -%}
                  {%- if states("sensor.mail_usps_mail")|int == 0 -%}
                    No
                  {%- else -%}
                    {{states("sensor.mail_usps_mail")|int}}
                  {%- endif -%}
                {{' '}} 
                  {%- if states("sensor.mail_usps_mail")|int <= 1 -%}
                    pieces of mail
                  {%- else -%}
                    pieces of mail
                  {%- endif -%}
                {{' '}}will be delivered.{{' '}} 
                  {%- if states("sensor.mail_usps_delivering")|int == 0 -%}
                    No
                  {%- else -%}
                    {{states("sensor.mail_usps_delivering")|int}}
                  {%- endif -%}
                {{' '}} 
                  {%- if states("sensor.mail_usps_delivering")|int == 1 -%}
                    USPS package is
                  {%- else -%}
                    USPS packages are
                  {%- endif -%}
                {{' '}}in transit.{{' '}}
                  {%- if states("sensor.mail_fedex_delivering")|int == 0 -%}
                    No
                  {%- else -%}
                    {{states("sensor.mail_fedex_delivering")|int}}
                  {%- endif -%}
                {{' '}} 
                  {%- if states("sensor.mail_fedex_delivering")|int == 1 -%}
                    FedEx package is
                  {%- else -%}
                    Fedex packages are
                  {%- endif -%}
                {{' '}}in transit.{{' '}}
                {%- if states("sensor.mail_ups_delivering")|int == 0 -%}
                    No
                  {%- else -%}
                    {{states("sensor.mail_ups_delivering")|int}}
                  {%- endif -%}
                {{' '}} 
                  {%- if states("sensor.mail_ups_delivering")|int == 1 -%}
                    UPS package is
                  {%- else -%}
                    UPS packages are
                  {%- endif -%}
                {{' '}}in transit.{{' '}}
                {%- if states("sensor.mail_amazon_packages")|int == 0 -%}
                    No
                  {%- else -%}
                    {{states("sensor.mail_amazon_packages")|int}}
                  {%- endif -%}
                {{' '}} 
                  {%- if states("sensor.mail_amazon_packages")|int == 1 -%}
                    Amazon package is
                  {%- else -%}
                    Amazon packages are
                  {%- endif -%}
                {{' '}}in transit.{{' '}}
            {%- endmacro %}
          {{deliveries_sentence()}}

binary_sensor:
  - platform: template
    sensors:
      are_packages_delivered:
        friendly_name: Package Delivery
        value_template: >
          {{states("sensor.number_of_packages")|int > 0}}

