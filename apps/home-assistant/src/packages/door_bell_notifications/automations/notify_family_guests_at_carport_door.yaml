automation:
  - alias: Notify family guests at the carport door
    id: notify_family_guests_at_carport_door
    trigger:
      platform: state
      entity_id: sensor.double_take_unknown
    condition:
      - condition: and
        conditions:
          - "{{ trigger.to_state.attributes.camera == 'car_port_door' }}"
          - "{{ state_attr('automation.notify_family_guests_at_carport_door', 'last_triggered') == None or (as_timestamp(now()) - as_timestamp(state_attr('automation.notify_family_guests_at_carport_door', 'last_triggered')) | int > 85)}}"
    action:
      - service: notify.all_devices
        data_template:
          title: "Guests at the door"
          message: "Guests at the carport door."
          data:
            image: "http://192.168.1.18:30529/api/storage/matches/{{ trigger.to_state.attributes.unknown.filename }}?box=true&token={{ states('sensor.double_take_token') }}"
            tag: "{{ trigger.to_state.attributes.id }}"
            when: "{{ strptime(trigger.to_state.attributes.timestamp, '%m/%d/%Y, %I:%M:%S %p') | as_timestamp | int }}"
            url: /lovelace/security
            click_action: /lovelace/security
            actions:
              - action: "URI"
                title: "View Live Feed"
                uri: "/lovelace/security"
            push:
              thread-id: security
