automation:
  - alias: Notify family guests at the front door
    id: notify_family_guests_at_front_door
    trigger:
      platform: mqtt
      topic: frigate/events
    condition:
      - condition: and
        conditions:
          - "{{ trigger.payload_json['after']['camera'] == 'front_door' }}"
          - "{{ trigger.payload_json['after']['label'] == 'person' }}"
          - condition: state
            entity_id: input_boolean.guest_at_front_door
            state: "off"
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.guest_at_front_door
      - service: notify.mobile_app_andrew_s_iphone
        data_template:
          title: "Guests at the door"
          message: "{{ states('sensor.front_door_person') }} {% if states('sensor.front_door_person')|int > 1 %}people{% else %}person{% endif %} at the front door."
          data:
            image: 'https://ha.smith-simms.family/api/frigate/notifications/{{trigger.payload_json["after"]["id"]}}/thumbnail.jpg?format=iphone'
            tag: '{{trigger.payload_json["after"]["id"]}}'
            when: '{{trigger.payload_json["after"]["start_time"]|int}}'
            url: "https://ha.smith-simms.family/api/camera_proxy/camera.front_door"
            push:
              thread-id: security
      - service: notify.mobile_app_dorri_s_iphone
        data_template:
          title: "Guests at the door"
          message: "{{ states('sensor.front_door_person') }} {% if states('sensor.front_door_person')|int > 1 %}people{% else %}person{% endif %} at the front door."
          data:
            image: 'https://ha.smith-simms.family/api/frigate/notifications/{{trigger.payload_json["after"]["id"]}}/thumbnail.jpg?format=iphone'
            tag: '{{trigger.payload_json["after"]["id"]}}'
            when: '{{trigger.payload_json["after"]["start_time"]|int}}'
            url: "https://ha.smith-simms.family/api/camera_proxy/camera.front_door"
            push:
              thread-id: security
