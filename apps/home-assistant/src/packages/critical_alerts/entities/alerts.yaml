template:
  - binary_sensor:
      - name: Water temperature alert
        device_class: problem
        unique_id: water_temperature_alert
        state: >
          {{ (states('sensor.water_temperature') | int(33)) < 32 or (state_attr('weather.main_floor', 'temperature') | int(33)) < 32 }}
      - name: Guests recently detected at carport door
        unique_id: guests_recently_detected_at_carport_door
        state: >
          {% set carport_door_minutes_difference = (as_timestamp(now()) -
            as_timestamp(states.binary_sensor.car_port_door_person_occupancy.last_changed)) / 60 %}
          {{ (carport_door_minutes_difference <= 5 and states('binary_sensor.car_port_door_person_occupancy', 'off')) or states('binary_sensor.car_port_door_person_occupancy') or states('binary_sensor.carport_doorbell_doorbell') }}
      - name: Guests recently detected at front door
        unique_id: guests_recently_detected_at_front_door
        state: >
          {% set front_door_minutes_difference = (as_timestamp(now()) -
            as_timestamp(states.binary_sensor.front_door_person_occupancy.last_changed)) / 60 %}
          {{ (front_door_minutes_difference <= 5 and states('binary_sensor.front_door_person_occupancy', 'off')) or states('binary_sensor.front_door_person_occupancy') or states('binary_sensor.front_doorbell_doorbell') }}
      - name: Guests recently detected
        unique_id: guests_recently_detected
        state: >
          {{ states('binary_sensor.guests_recently_detected_at_carport_door') or states('binary_sensor.guests_recently_detected_at_front_door') }}

  - sensor:
      - name: Under Sink Leak Detections
        unique_id: under_sink_leak_detections
        state: >
          {% for entity_id in states.group.under_sink_leak_detectors.attributes.entity_id %}{% set parts = entity_id.split('.') %}{% if states(entity_id) == 'on' %}{% if loop.first %}{% elif loop.last %} and {% else %}, {% endif %}{{ state_attr(entity_id, 'friendly_name') }}{% endif %}{% endfor %}

group:
  under_sink_leak_detectors:
    name: Under Sink Leak Detectors
    entities:
      - binary_sensor.guest_bathroom_sink_1_ias_zone
      - binary_sensor.guest_bathroom_sink_2_ias_zone
      - binary_sensor.office_bathroom_sink_ias_zone

binary_sensor:
  - platform: group
    name: Any Alerts
    device_class: problem
    entities:
      - binary_sensor.pending_system_alerts
      - binary_sensor.water_temperature_alert
      - binary_sensor.guest_bathroom_sink_1_ias_zone
      - binary_sensor.guest_bathroom_sink_2_ias_zone
      - binary_sensor.office_bathroom_sink_ias_zone
      - binary_sensor.guests_recently_detected

  - platform: group
    name: Under Sink Leak
    device_class: problem
    entities:
      - binary_sensor.guest_bathroom_sink_1_ias_zone
      - binary_sensor.guest_bathroom_sink_2_ias_zone
      - binary_sensor.office_bathroom_sink_ias_zone
