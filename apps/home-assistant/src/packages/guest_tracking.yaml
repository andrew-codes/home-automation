group:
  guests:
    name: Guests
    entities: []

automation:
  - alias: Renew guest devices
    trigger:
      - platform: time
        at: 01:00:00
    action:
      - service: mqtt.publish
        data:
          topic: "/homeassistant/guest/renew-devices"

  - alias: Notify family members when someone is at the door and no one is home
    id: notify_guests_at_door
    trigger:
      - platform: template
        id: front_door
        value_template: "{% if states('sensor.front_door_person') > 0 %}true{% endif %}"
        for: "00:00:25"
      - platform: template
        id: car_port_door
        value_template: "{% if states('sensor.car_port_door_person') > 0 %}true{% endif %}"
        for: "00:00:25"
    condition:
      - condition: state
        entity_id: group.family
        state: not_home
      - condition: state
        entity_id: binary_sensor.doorbell_carport_doorbell
        state: "off"
      - condition: state
        entity_id: binary_sensor.doorbell_front_doorbell
        state: "off"
    action:
      - alias: "Set up variables for the door lock action"
        variables:
          action_lock: "{{ 'DOOR_LOCK' ~ context.id }}"
      - choose:
          # IF front door
          - conditions:
              - condition: trigger
                id: front_door
            sequence:
              - alias: "Set up variables for the front door"
                variables:
                  door: "front door"
                  lock_entity: lock.front_door_deadbolt
          # else if car port door
          - conditions:
              - condition: trigger
                id: car_port_door
            sequence:
              - alias: "Set up variables for the front door"
                variables:
                  door: "car port door"
                  lock_entity: lock.car_port_deadbolt
                  message_prefix: "{{ states('sensor.car_port_door_person') }} {% if states('sensor.car_port_door_person') > 1 %}people{% else %}person{% endif %}"
      - service: notify.mobile_app_andrew_s_iphone
        data_template:
          title: "{{ message_prefix }} at {{ door }}"
          message: ""
          data:
            actions:
              - action: "{{ action_lock }}"
                title: "Unlock {{ door }}"
                authenticationRequired: false
            push:
              thread-id: security
      # - service: notify.mobile_app_dorri_s_iphone
      #   data_template:
      #     title: "People at {{ door }}"
      #     message: ""
      #     data:
      #       actions:
      #         - action: "{{ action_lock }}"
      #           title: "Unlock {{ door }}"
      #           authenticationRequired: false
      #       push:
      #         thread-id: security
      - alias: "Wait for a action lock response"
        wait_for_trigger:
          - platform: event
            event_type: mobile_app_notification_action
            event_data:
              # waiting for the specific action avoids accidentally continuing
              # for another script/automation's notification action
              action: "{{ action_lock }}"
        timeout:
          minutes: 5
        continue_on_timeout: false
      - service: lock.unlock
        data:
          entity_id: "{{ lock_entity }}"
